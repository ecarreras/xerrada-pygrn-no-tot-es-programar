<!DOCTYPE html>
<html>
  <head>
 ¬† ¬†<title>No tot √©s programar!</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Roboto);
      @import url(https://fonts.googleapis.com/css?family=Roboto+Mono);

      body { font-family: 'Roboto'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Roboto Mono'; font-size: 0.6em }
      .small {
        font-size: 0.8em;
      }
      a:link, a:visited {
        color: #E40066;
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <textarea id="source">
class: center, middle
count: false
# No tot √©s programar!
## Documentar, testejar, integrar, desplegar i monitoritzar

![PyGRN](https://avatars1.githubusercontent.com/u/28831124?v=4&s=200)

[Eduard Carreras i Nadal](mailto:ecarreras@gmail.com)

13/09/2017 - PyGRN #2

[![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)

---

# Qui s√≥c jo?

- S√≥c un infiltrat en el m√≥n del software (s√≥c teleco)
- Apassionat del software i del proƒáes **art**esanal.
- Co-Fundador de [GISCE-TI, S.L](http://gisce.net)
- Desenvolupant en Python des del 2007 (Python ‚ù§Ô∏è)
- Amant del programari lliure
- [LinkedIn](https://www.linkedin.com/in/ecarreras/), [Twitter](https://twitter.com/ecarreras)
  i [GitHub](https://github.com/ecarreras)

---

# Agenda

  1. Documentaci√≥ de projectes
  2. Testing
  3. Integraci√≥ cont√≠nua
  4. Desplegament
  5. Monitoritzaci√≥

???

Separar√© la xerrada en aquests blocs

T√© a veure amb el cicle que m'agradaria

---
# Documentaci√≥ de projectes

- Documentaci√≥ t√®cnica (APIs)
- Documentaci√≥ d'usuari (manuals)

---

## Documentaci√≥ t√®cnica (APIs)

- [PEP 257 -- Docstring Conventions](https://www.python.org/dev/peps/pep-0257/)

  A docstring is a string literal that occurs as the first statement in a module,
  function, class, or method definition. Such a docstring becomes the `__doc__`
  special attribute of that object.

```python
"""Aquest m√≤dul de python t√© funcions per saludar"""


def hola():
    """Aix√≤ imprimeix Hola!"""
    print('Hola!')
```

- Podem consultar l'ajuda des de l'entorn python `help(hola)`
  o `hola.__doc__`

- Ens haur√≠em d'acostumar m√©s a escriure *docstrings* com a documentaci√≥ t√®cnica.
  No nom√©s les signatures de les funcions.

---
## Documentaci√≥ t√®cnica (APIs) - Hist√≤ria

- No hi havia cap est√†ndard definit.
- Qu√® passa quan es vol *enriquir* una mica el text?
  - HTML, DocBook, TeX, ...

### Objectius

 - Ha de ser f√†cil de llegir des del propi codi font
 - F√†cil d'escriure des de qualsevol editor
 - No ha de tenir informaci√≥ que hagi de ser dedu√Øda de parsejar el m√≤dul
 - Ha de tenir prou *estructura* per poder-se convertir a altres formats
 - Ha de ser f√†cil escriure **tota** la documentaci√≥ d'un m√≤dul c√≤modament

### Soluci√≥

 - [PEP 287 -- reStructuredText Docstring Format](https://www.python.org/dev/peps/pep-0287/)

---

## Documentaci√≥ t√®cnica (APIs) - ReStructuredText exemple

```python
class Keeper(Storer):

    """Keep data fresher longer.

    Extend `Storer`.  Class attribute `instances` keeps track
    of the number of `Keeper` objects instantiated.
    """

    instances = 0
    """How many `Keeper` objects are there?"""

    def __init__(self):
        """
        Extend `Storer.__init__()` to keep track of
        instances.  Keep count in `self.instances` and data
        in `self.data`.
        """
        Storer.__init__(self)
        self.instances += 1

        self.data = []
        """Store data in a list, most recent last."""

    def storedata(self, data):
        """
        Extend `Storer.storedata()`; append new `data` to a
        list (in `self.data`).
        """
        self.data = data
```
---
## Documentaci√≥ t√®cnica (APIs) - Metainformaci√≥

- Diferents formats de metainformaci√≥
  - ReStructuredText
  - [Google](http://google.github.io/styleguide/pyguide.html?showone=Comments#Comments)
  - [Numpy](https://github.com/numpy/numpy/blob/master/doc/HOWTO_DOCUMENT.rst.txt)
  - [PEP 3107 -- Function Annotations](https://www.python.org/dev/peps/pep-3107/)
    (nom√©s Python 3!)

### ReStructuredText

```python
def stupid_method(first, second):
    """Aquest m√®tode retorna la suma dels dos par√†metres.

    :param int first: El primer par√†mentre
    :param int second: El segon par√†mentre
    :return: La suma dels par√†metres
    :rtype: int
    :raises ValueError: Si algun dels dos par√†metres no √©s un enter
    """
    if not (isinstance(first, int) and isinstance(second int)):
        raise ValueError("must be integers!")
    return first + second
```

---
## Documentaci√≥ t√®cnica (APIs) - Metainformaci√≥
### Google

```python
def stupid_method(first, second):
    """Aquest m√®tode retorna la suma dels dos par√†metres.

    Args:
        first: Un int com a primer par√†metre.
        second: Un int com a segon par√†metre.

    Returns:
        Un int corresponent a la suma dels par√†metres

    Raises:
        ValueError: Si algun dels dos par√†metres no √©s un enter
    """
    if not (isinstance(first, int) and isinstance(second, int)):
        raise ValueError("must be integers!")
    return first + second
```
---

## Documentaci√≥ t√®cnica (APIs) - Metainformaci√≥
### Numpy

```python
def stupid_method(first, second):
    """Aquest m√®tode retorna la suma dels dos par√†metres.

    Parametres
    ----------
    first: int
           Un int com a primer par√†metre.
    second: int
            Un int com a segon par√†metre.

    Returns
    -------
    int
        La suma dels par√†metres

    Raises
    ------
    ValueError
        Si algun dels dos par√†metres no √©s un enter
    """
    if not (isinstance(first, int) and isinstance(second, int)):
        raise ValueError("must be integers!")
    return first + second
```

---

## Documentaci√≥ t√®cnica (APIs) - Metainformaci√≥
### Function Annotations

```python
def stupid_method(first: int, second: int) -> int:
    """Aquest m√®tode retorna la suma dels dos par√†metres.

    :param first: El primer par√†mentre
    :param second: El segon par√†mentre
    :return: La suma dels par√†metres
    :raises ValueError: Si algun dels dos par√†metres no √©s un enter
    """
    if not (isinstance(first, int) and isinstance(second, int)):
        raise ValueError("must be integers!")
    return first + second
```
```python
def stupid_method(first: "El primer par√†mentre",
                  second: "El segon par√†mentre") -> "La suma dels par√†metres":
    """Aquest m√®tode retorna la suma dels dos par√†metres.

    :raises ValueError: Si algun dels dos par√†metres no √©s un enter
    """
    if not (isinstance(first, int) and isinstance(second, int)):
        raise ValueError("must be integers!")
    return first + second
```

- Podem accedir a la informaci√≥ des de l'int√®rpret. `supid_method.func_annotations`
  i retorna un diccionari amb les anotacions.

---

## Documentaci√≥ t√®cnica (APIs) - Doctest

- Barreja entre tenir documentaci√≥, exemples i tests. (3 en 1).
- La [documentaci√≥ de doctest](https://docs.python.org/3/library/doctest.html)
  √©s molt extensa i permet fer moltes coses.

```python
def stupid_method(first, second):
    """Aquest m√®tode retorna la suma dels dos par√†metres.

    >>> stupid_method(1, 2)
    3
    >>> stupid_method("a", 2)
    Traceback (most recent call last):
      ...
    ValueError: must be integers!
    >>> stupid_method(1, "a")
    Traceback (most recent call last):
      ...
    ValueError: must be integers!
    """
    if not (isinstance(first, int) and isinstance(second, int)):
        raise ValueError("must be integers!")
    return first + second

if __name__ == '__main__':
    import doctest
    doctest.testmod()
```

- Podem llan√ßar els tests directament amb:

```sh
$ python stupid.py -v
```

---

## Documentaci√≥ t√®cnica (APIs) - Eina
### [Sphinx](http://www.sphinx-doc.org)

√âs una eina per **crear documentaci√≥** i podem destacar les seg√ºents funcionalitats:
  - **Diferents formats de sortida**: HTML (diferents temes), WinHelp,
    LaTeX (pels PDFs), ePub, Texinfo, manpages, text pla.
  - **Refer√®ncies creuades**: Enlla√ßos sem√†ntics autom√†tics de funcions, classes,
    definicions, ... Fins i tot d'altres documentacions!
  - **Estructura jer√†rquica**: Tot queda organitzat en arbre.
  - **√çndex autom√†tics**: √çndex general i tamb√© de tots els m√≤duls.
  - **Visualitzaci√≥ de codi**: Fent servir la llibreria de resaltat [Pygments](http://pygments.org/)
  - **Extensible**: [Extensions pr√≤pies](http://www.sphinx-doc.org/en/stable/ext/builtins.html#builtin-sphinx-extensions)
    o de tercers [instal¬∑lables des de Pypi](https://pypi.org/search/?q=sphinx+extension)

T√© un assistent per la creaci√≥ de projectes:

```sh
$ pip install Sphinx
$ sphinx-quickstart my-project
```

---

## Documentaci√≥ d'usuari (on i com?)

- ~~Processadors de text~~

  **Al carrer!üëã** El descartem directament.

  - Formats pesats i normalment s√≥n binaris
  - Dificultat per fer edici√≥ per parts o de forma distribu√Øda
  - Dificultat per gestionar un hist√≤ric de canvis
  - Dificultat per gestionar revisions de canvis i ampliacions

  **‚ú® Spoiler**: [Tracte la documentaci√≥ com si fos codi](https://github.com/blog/1939-how-github-uses-github-to-document-github)

  - Fes servir un format de text pla que pugui ser escrit i editat des de
    qualsevol editor.
  - Guarda el manual en un repositori de control de versions (Git)
      - Podem editar per parts o de forma distribu√Øda gr√†cies al control de versions
      - Tenim hist√≤ric!
      - Tenim un sistema de *Pull requests* per revisar i aprovar canvis (Merge!)
  - Fins i tot podem tenir tests del manual!

---
## Documentaci√≥ d'usuari (format)

Hi ha dos formats de text pla que s√≥n √†mpliament reconeguts:
- ReStructuredText
- Markdown (ho est√† petant!)

---
## Documentaci√≥ d'usuari (format)

### ReStructuredText vs Markdown

#### ReStructuredText

- üîù Sphinx √©s una de les millors eines de generaci√≥ de documentaci√≥
- üîù Molt potent. Suporta refer√®ncies, notes de peu, bibliografia
- üîù Moltes, moltes i moltes extensions
- ‚ùå Sint√†xis for√ßa complexe

#### Markdown

 - üîù Sintaxi senzilla
 - ‚ùå Hi ha diferents "sabors" ‚ûú [CommonMark](http://commonmark.org/)
 - ‚ùå Poques funcionalitats avan√ßades
---
## Documentaci√≥ d'usuari (eines)

- Ja hem parlat d'[Sphinx](#14)
- Presentem tamb√© una eina per Markdown: [MKdocs](http://www.mkdocs.org/)
  - No t√© tants suports de sortida com ReStructuredText + Sphinx
  - D'una forma f√†cil pots tenir una p√†gina amb manual d'usuari
  - Fem m√©s f√†cil la col¬∑laboraci√≥ per membres no t√®cnics
  - Extensible amb totes les extensions de [Python-Markdown](https://pythonhosted.org/Markdown/)
- Publicaci√≥: [ReadTheDocs](https://readthedocs.org/)

### Cicle possible
.small[
1. Creem una branca per afegir/modificar documentaci√≥
2. Work and commit
3. Push!
4. Pull-request
5. Testing (el format √©s v√†lid, hi ha traduccions?, faltes d'ortografia, ...)
6. Construcci√≥ del lloc temporal amb els canvis
7. Revisi√≥
8. Merge
9. Publicaci√≥ autom√†tica nova versi√≥]


---
## Testing (Qu√® √©s?)

**Possible definici√≥**:
>> La prova de programari √©s un conjunt de processos dirigits a investigar,
avaluar i determinar la **integritat** i la **qualitat** del programari inform√†tic.

>> Les proves de programari garanteixen el **compliment** d'un producte de programari
en relaci√≥ **amb els requisits** regulatoris, empresarials, t√®cnics, funcionals
i d'usuaris.

---
## Testing (Quins hi ha)

Definici√≥ per [Robert C. Martin](https://en.wikipedia.org/wiki/Robert_Cecil_Martin)
dels [tipus de tests](http://blog.cleancoder.com/uncle-bob/2017/05/05/TestDefinitions.html).

  - **Tests unitaris**: Escrit pel programador per tal que el codi faci el que el
    programador espera que faci.

  - **Tests d'acceptaci√≥**: Escrit per *Negoci* amb el prop√≤sit que el codi faci el
    que *Negoci* necessita.

  - **Tests d'integraci√≥**: Assegurar-se que els **subsistemes** funcionen de forma
    correcta entre ells. (No tenen a veure amb regles de *negoci*)

  - **Tests de sistema**: Semblants als d'integraci√≥ per√≤ amb **tot el sistema**

  - **Micro-tests**: Semblant als tests unitaris, per√≤ per una sola funci√≥ o
    un grup de tests molt reduit.

  - **Tests funcionals**: Tests amb un abast m√©s gran amb *mocks* per els components
    m√©s lents.

---
## Testing (Quan els fem)

- Abans o depr√©s?
  - Despr√©s els tests poden estar *viciats*
  - Testejarem **totes** les funcionalitats que hem escrit?
  - **TDD al rescat!**
- Desenvolupament guiat per exemples
- [Regles del TDD](http://www.eferro.net/2012/09/resumen-clean-coders-capitulo-6-tdd.html):
  - **No** escriure codi de producci√≥ si no √©s perqu√® un test est√† fallant
  - Escriure el **m√≠nim** d'un test per fer fallar
  - Escriure el **m√≠nim** codi necessari per passar el test
- Tenim sempre el test abans d'escriure el codi ‚ûú **Bona cobertura**

### ‚ô™ Uh! Oh! No tinc por! ‚ô´

- **No ens fa por** netejar el codi
- **No ens fa por** canviar codi
- **No ens fa por** afegir noves funcionalitats
  - Avancem **m√©s r√†pid**
---
## Testing (eines)

### Execuci√≥ de tests (UnitTest) + `self.assertX`:
- Llibreria est√†ndard ([unittest](https://docs.python.org/3/library/unittest.html))

```python
class TestStupidMethod(TestCase):
    def test_two_integers_returns_the_sum(self):
        result = stupid_method(1, 2)
        self.assertEqual(result, 3)

    def test_first_param_no_integer_raises_value_error(self):
        def raise_value_error():
            stupid_method("a", 1)
        self.assertRaises(ValueError, raise_valueerror)
```

- Millores a la llibreria est√†ndard (UnitTesting):
  - üîù [PyTest](https://docs.pytest.org)
  - ‚ùå [Nose2](http://nose2.readthedocs.io)

---
## Testing (eines)

### Execuci√≥ de tests (BDD) + [Expects](https://expects.readthedocs.io/en/stable/):

- [Behave](http://pythonhosted.org/behave/)
- [Mamba](http://nestorsalceda.github.io/mamba/)

```python
with description('Using the stupid_method'):
    with context('when passing two integers'):
        with it('should return the sum of them'):
            result = stupid_method(1, 2)
            expect(result).to(equal(3))
    with context('when passing a string and an integer'):
        with it('should raise a ValueError'):
            def raises_value_error():
                stupid_method("a", 1)
            expect(raise_value_error).to(raise_error(ValueError))
```

### Tests funcionals (eines)

- [doublex](http://python-doublex.readthedocs.io/en/latest/)
- [Mock](https://docs.python.org/3/library/unittest.mock.html)
- [vcrpy](http://vcrpy.readthedocs.io/en/latest/)

---
## Integraci√≥ Cont√≠nua (CI)

- Tots els canvis s'han d'integrar a la branca *principal*: **r√†pid**
- S'han de passar els tests per comprovar que aquests canvis s√≥n correctes
- Evita tenir el *caos* de la release
- Ens permet tenir sempre una versi√≥ *testing* (binari)
- Trobem r√†pid bugs d'integraci√≥
- Obtenir m√®triques d'evoluci√≥: cobertura, complexitat, fallades.

### Eines

- [Buildbot](https://buildbot.net/) (Python powered)
- [Jenkins](https://jenkins.io/)
- [Drone](https://github.com/drone/drone)
- [Travis](https://travis-ci.org/)
- [CircleCI](https://circleci.com/)
- ...

---

## Desplegament

- Conjunt d'activitats que fa que un sofware sigui utiltizable.
- On? Altres serveis? pre-condicions, post-condicions
- 3 nivells de desplegament
    - Manual
    - Semi-autom√†tic
    - Autom√†tic ‚ûú Augmentar n√∫mero de desplegaments

### Eines
- [Fabric](http://www.fabfile.org/) + [Fabtools](http://fabtools.readthedocs.io):
  Executa ordres remotes a trav√©s de SSH
- [Ansible](https://www.ansible.com/application-deployment): Llibres de receptes
  amb un sistema de plantilles molt potent i moltes receptes ja fetes
- [dh-virtualenv](http://dh-virtualenv.readthedocs.io/en/latest/): Crea paquets
  compatibles amb Debian amb un *virtualenv* autocontingut

---

## Monitoritzar

- Volem fer desplegaments m√©s sovint
- Provar una funcionalitat a producci√≥
- Ser pro-actius
- M√©s informaci√≥ de l'error

### Eines

- [Sentry](https://github.com/getsentry/sentry) (Python powered)

---
class: center, middle

# Preguntes?
# üôà üôâ üôä

---
class: center, middle

# Moltes gr√†cies!

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create({
        highlightStyle: 'darcula',
        highlightLanguage: 'remark',
        highlightLines: true,
        slideNumberFormat: '%current%/%total%',
        ratio: '4:3'
      });
    </script>
    <!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-370946-8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-370946-8');
</script>

  </body>
</html>
